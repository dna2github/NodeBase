<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Instance Manager - WSTun</title>
    <style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: Arial, sans-serif; background: #f5f5f5; min-height: 100vh; padding: 20px; }
.container { max-width: 600px; margin: 0 auto; }
.card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
h1 { color: #6200ee; margin-bottom: 8px; }
h2 { color: #333; margin-bottom: 16px; font-size: 18px; }
.subtitle { color: #666; margin-bottom: 20px; }
.btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; }
.btn-primary { background: #6200ee; color: white; }
.btn-primary:hover { background: #3700b3; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.input-group { margin-bottom: 15px; }
.input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
.input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
.info-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; }
.info-box code { background: #fff; padding: 2px 6px; border-radius: 4px; font-family: monospace; word-break: break-all; }
.link { color: #6200ee; text-decoration: none; }
.link:hover { text-decoration: underline; }
.success { background: #e8f5e9; color: #2e7d32; padding: 12px; border-radius: 6px; margin: 10px 0; }
.instance-list { margin-top: 15px; }
.instance-item { padding: 12px; margin: 8px 0; background: #f9f9f9; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
.instance-info { flex: 1; }
.instance-name { font-weight: bold; }
.instance-meta { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Chat</h1>
            <p class="subtitle">Create a chat room</p>
            
            <div class="input-group">
                <label for="serverToken">Server Auth Token (if required)</label>
                <input type="text" id="serverToken" placeholder="Leave empty if not required">
            </div>
            <div class="input-group">
                <label for="roomName">Room Name</label>
                <input type="text" id="roomName" placeholder="My Chat Room" value="Chat Room">
            </div>
            <div class="input-group">
                <label for="roomToken">Room Token (optional, for private rooms)</label>
                <input type="text" id="roomToken" placeholder="Leave empty for public room">
            </div>
            
            <button class="btn btn-primary" onclick="createInstance()">Create Room</button>
            
            <div id="result" style="display:none;"></div>
        </div>
        
        <div class="card">
            <h2>Existing Rooms</h2>
            <p class="subtitle">Click to open the chat page</p>
            <div id="instanceList" class="instance-list">
                <p style="color:#666;text-align:center;">Loading...</p>
            </div>
            <button class="btn" style="margin-top:15px;background:#eee;color:#333;" onclick="loadInstances()">Refresh</button>
        </div>
    </div>

    <script src="/libwstun.js"></script>
    <script>
const SERVICE = 'chat';
const serverToken = document.getElementById('serverToken');
let activeHost = null;
let activeInstanceUuid = null;
let activeInstanceToken = null;

// Session storage keys for reconnection
const STORAGE_KEY_UUID = 'chat_instance_uuid';
const STORAGE_KEY_TOKEN = 'chat_instance_token';
const STORAGE_KEY_NAME = 'chat_instance_name';

// Try to restore session on page load
function tryRestoreSession() {
    const savedUuid = sessionStorage.getItem(STORAGE_KEY_UUID);
    const savedToken = sessionStorage.getItem(STORAGE_KEY_TOKEN);
    const savedName = sessionStorage.getItem(STORAGE_KEY_NAME);
    
    if (savedUuid) {
        console.log('Attempting to reclaim instance:', savedUuid);
        reclaimInstance(savedUuid, savedToken, savedName);
        return true;
    }
    return false;
}

function reclaimInstance(uuid, token, name) {
    const sToken = serverToken.value.trim() || null;
    
    document.getElementById('result').style.display = 'block';
    document.getElementById('result').innerHTML = '<div style="color:#666;padding:12px;">Reconnecting to room...</div>';
    
    activeHost = WSTun.createInstanceHost({
        service: SERVICE,
        name: name || 'Chat Room',
        serverToken: sToken,
        instanceToken: token,
        reclaimUuid: uuid,
        onOpen: () => {
            console.log('WebSocket connected for reclaim');
        },
        onInstanceReclaimed: (payload) => {
            activeInstanceUuid = payload.uuid;
            activeInstanceToken = token;
            
            const joinUrl = location.origin + '/chat/main#instance=' + payload.uuid + 
                (token ? '&token=' + encodeURIComponent(token) : '') +
                (sToken ? '&server_token=' + encodeURIComponent(sToken) : '');
            
            document.getElementById('result').innerHTML = `
                <div class="success">Reconnected to room!</div>
                <div class="info-box">
                    <p><strong>Room UUID:</strong> <code>${payload.uuid}</code></p>
                    <p><strong>Users:</strong> ${payload.userCount || 0}</p>
                    <p><strong>Join URL:</strong></p>
                    <p><a href="${joinUrl}" class="link" target="_blank">${joinUrl}</a></p>
                </div>
            `;
            
            loadInstances();
        },
        onInstanceCreated: (payload) => {
            // Reclaim failed, new instance created
            activeInstanceUuid = payload.uuid;
            activeInstanceToken = token;
            sessionStorage.setItem(STORAGE_KEY_UUID, payload.uuid);
            if (token) sessionStorage.setItem(STORAGE_KEY_TOKEN, token);
            sessionStorage.setItem(STORAGE_KEY_NAME, name || 'Chat Room');
            
            const joinUrl = location.origin + '/chat/main#instance=' + payload.uuid + 
                (token ? '&token=' + encodeURIComponent(token) : '') +
                (sToken ? '&server_token=' + encodeURIComponent(sToken) : '');
            
            document.getElementById('result').innerHTML = `
                <div class="success">Room created (previous session expired)!</div>
                <div class="info-box">
                    <p><strong>Room UUID:</strong> <code>${payload.uuid}</code></p>
                    <p><strong>Join URL:</strong></p>
                    <p><a href="${joinUrl}" class="link" target="_blank">${joinUrl}</a></p>
                </div>
            `;
            
            loadInstances();
        },
        onError: (err) => {
            const msg = err && err.message ? err.message : (typeof err === 'string' ? err : 'Failed to reconnect');
            document.getElementById('result').innerHTML = `<div style="background:#ffebee;color:#c62828;padding:12px;border-radius:6px;">Error: ${msg}</div>`;
            // Clear saved session
            sessionStorage.removeItem(STORAGE_KEY_UUID);
            sessionStorage.removeItem(STORAGE_KEY_TOKEN);
            sessionStorage.removeItem(STORAGE_KEY_NAME);
        },
        onClose: () => {
            console.log('Instance host connection closed');
        }
    });
    
    activeHost.connect();
}

async function createInstance() {
    // Clean up old connection if any
    if (activeHost) {
        activeHost.disconnect();
        activeHost = null;
    }
    
    const name = document.getElementById('roomName').value.trim() || 'Chat Room';
    const token = document.getElementById('roomToken').value.trim() || null;
    const sToken = serverToken.value.trim() || null;
    
    document.getElementById('result').style.display = 'block';
    document.getElementById('result').innerHTML = '<div style="color:#666;padding:12px;">Creating room...</div>';
    
    activeHost = WSTun.createInstanceHost({
        service: SERVICE,
        name: name,
        serverToken: sToken,
        instanceToken: token,
        onOpen: () => {
            console.log('WebSocket connected for instance creation');
        },
        onInstanceCreated: (payload) => {
            activeInstanceUuid = payload.uuid;
            activeInstanceToken = token;
            
            // Save to session storage for reconnection on refresh
            sessionStorage.setItem(STORAGE_KEY_UUID, payload.uuid);
            if (token) sessionStorage.setItem(STORAGE_KEY_TOKEN, token);
            sessionStorage.setItem(STORAGE_KEY_NAME, name);
            
            const joinUrl = location.origin + '/chat/main#instance=' + payload.uuid + 
                (token ? '&token=' + encodeURIComponent(token) : '') +
                (sToken ? '&server_token=' + encodeURIComponent(sToken) : '');
            
            document.getElementById('result').innerHTML = `
                <div class="success">Room created successfully!</div>
                <div class="info-box">
                    <p><strong>Room UUID:</strong> <code>${payload.uuid}</code></p>
                    <p><strong>Join URL:</strong></p>
                    <p><a href="${joinUrl}" class="link" target="_blank">${joinUrl}</a></p>
                </div>
            `;
            
            loadInstances();
        },
        onError: (err) => {
            const msg = err && err.message ? err.message : (typeof err === 'string' ? err : 'Failed to create room');
            document.getElementById('result').innerHTML = `<div style="background:#ffebee;color:#c62828;padding:12px;border-radius:6px;">Error: ${msg}</div>`;
        },
        onClose: () => {
            console.log('Instance host connection closed');
        }
    });
    
    activeHost.connect();
}

async function loadInstances() {
    document.getElementById('instanceList').innerHTML = '<p style="color:#666;text-align:center;">Loading rooms...</p>';
    try {
        const sToken = serverToken.value.trim() || null;
        const instances = await WSTun.listInstances(SERVICE, sToken);
        renderInstances(instances);
    } catch (err) {
        console.error('Failed to load instances:', err);
        document.getElementById('instanceList').innerHTML = '<p style="color:#666;text-align:center;">No rooms available</p>';
    }
}

function renderInstances(instances) {
    const el = document.getElementById('instanceList');
    if (!instances || instances.length === 0) {
        el.innerHTML = '<p style="color:#666;text-align:center;">No rooms available</p>';
        return;
    }
    
    const sToken = serverToken.value.trim();
    el.innerHTML = instances.map(inst => {
        const url = '/chat/main#instance=' + inst.uuid + 
            (sToken ? '&server_token=' + encodeURIComponent(sToken) : '');
        const isOwner = inst.uuid === activeInstanceUuid;
        return `
        <div class="instance-item">
            <div class="instance-info">
                <div class="instance-name">${esc(inst.name)}${isOwner ? ' (yours)' : ''}</div>
                <div class="instance-meta">UUID: ${inst.uuid} | Users: ${inst.userCount}${inst.hasToken ? ' | Private' : ''}${!inst.ownerConnected ? ' | Owner disconnected' : ''}</div>
            </div>
            <a href="${url}" class="btn btn-primary" target="_blank">Open</a>
        </div>`;
    }).join('');
}

function esc(s) {
    return s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
}

// Try to restore session first, then load instances
if (!tryRestoreSession()) {
    loadInstances();
} else {
    loadInstances();
}
    </script>
</body>
</html>

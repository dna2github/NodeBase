<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - WSTun</title>
    <style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: Arial, sans-serif; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
.join-view { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 450px; }
.join-view h1 { color: #6200ee; margin-bottom: 20px; }
.join-view input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
.join-view button { width: 100%; padding: 12px; background: #6200ee; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 10px; }
.join-view button:disabled { opacity: 0.5; }
.room-list { list-style: none; text-align: left; margin: 15px 0; max-height: 200px; overflow-y: auto; }
.room-item { padding: 12px; margin: 8px 0; background: #f5f5f5; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
.room-info { flex: 1; }
.room-name { font-weight: bold; color: #333; }
.room-meta { font-size: 12px; color: #666; }
.room-item button { padding: 6px 12px; font-size: 14px; width: auto; margin: 0; }
.chat { display: none; flex-direction: column; height: 100vh; }
.chat.active { display: flex; }
.chat-header { padding: 15px 20px; background: white; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
.chat-header h2 { color: #333; }
.chat-header .users-count { color: #666; font-size: 14px; }
.chat-header button { padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; }
.messages { flex: 1; overflow-y: auto; padding: 20px; }
.message { margin: 10px 0; max-width: 70%; }
.message.own { margin-left: auto; }
.message-content { padding: 10px 15px; border-radius: 12px; background: white; }
.message.own .message-content { background: #6200ee; color: white; }
.message-header { font-size: 12px; color: #666; margin-bottom: 4px; }
.message.own .message-header { color: rgba(255,255,255,0.7); }
.message.system { max-width: 100%; text-align: center; }
.message.system .message-content { background: transparent; color: #666; font-style: italic; }
.input-area { background: white; padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
.input-area input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
.input-area button { padding: 12px 24px; background: #6200ee; color: white; border: none; border-radius: 6px; cursor: pointer; }
.hidden { display: none !important; }
.divider { margin: 20px 0; border-top: 1px solid #eee; padding-top: 15px; }
.divider-text { color: #999; font-size: 14px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div id="joinView" class="join-view">
        <h1>Join Chat Room</h1>
        <div id="status" style="color:#666;margin-bottom:15px;">Loading rooms...</div>
        
        <div id="roomListContainer"></div>
        
        <div class="divider">
            <div class="divider-text">Or enter room details manually</div>
            <input type="text" id="instanceUuid" placeholder="Room UUID">
            <input type="text" id="instanceToken" placeholder="Room Token (if required)">
            <input type="text" id="nameInput" placeholder="Your name" maxlength="20">
            <button onclick="joinRoom()">Join Room</button>
        </div>
    </div>
    
    <div id="chatView" class="chat">
        <div class="chat-header">
            <div>
                <h2 id="roomTitle">Chat Room</h2>
                <span id="usersCount" class="users-count">0 users</span>
            </div>
            <button onclick="leaveChat()">Leave</button>
        </div>
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <input type="text" id="msgInput" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
    
    <script src="/libwstun.js"></script>
    <script>
const SERVICE = 'chat';
let client = null;
let myUserId = null;
let myName = null;
let users = new Map();     // userId -> {name, joinedAt}
let messages = [];         // [{type, userId, userName, content, ts}]

// Parse hash params
function getHashParams() {
    const hash = location.hash.substring(1);
    const params = {};
    hash.split('&').forEach(p => {
        const [k, v] = p.split('=');
        if (k) params[k] = decodeURIComponent(v || '');
    });
    return params;
}

const hashParams = getHashParams();
const serverToken = hashParams.server_token || null;
let instanceUuid = hashParams.instance || null;
let instanceToken = hashParams.token || null;

// Pre-fill form from hash params
if (instanceUuid) document.getElementById('instanceUuid').value = instanceUuid;
if (instanceToken) document.getElementById('instanceToken').value = instanceToken;
if (hashParams.name) document.getElementById('nameInput').value = hashParams.name;

// Load available rooms
async function loadRooms() {
    try {
        const rooms = await WSTun.listInstances(SERVICE, serverToken);
        renderRooms(rooms);
        document.getElementById('status').textContent = rooms.length > 0 
            ? 'Select a room or enter details below' 
            : 'No rooms available. Enter room details manually.';
    } catch (err) {
        document.getElementById('status').textContent = 'Enter room details to join';
    }
}

function renderRooms(rooms) {
    const container = document.getElementById('roomListContainer');
    if (!rooms || rooms.length === 0) {
        container.innerHTML = '';
        return;
    }
    container.innerHTML = '<ul class="room-list">' + rooms.map(r => 
        `<li class="room-item">
            <div class="room-info">
                <div class="room-name">${esc(r.name)}</div>
                <div class="room-meta">${r.userCount} user(s)${r.hasToken ? ' â€¢ Token required' : ''}</div>
            </div>
            <button onclick="selectRoom('${r.uuid}', ${r.hasToken})">Join</button>
        </li>`
    ).join('') + '</ul>';
}

function selectRoom(uuid, hasToken) {
    document.getElementById('instanceUuid').value = uuid;
    if (hasToken) {
        document.getElementById('instanceToken').focus();
    } else {
        document.getElementById('nameInput').focus();
    }
}

function joinRoom() {
    instanceUuid = document.getElementById('instanceUuid').value.trim();
    instanceToken = document.getElementById('instanceToken').value.trim() || null;
    myName = document.getElementById('nameInput').value.trim();
    
    if (!instanceUuid) {
        alert('Please enter a room UUID or select a room');
        return;
    }
    if (!myName) {
        alert('Please enter your name');
        return;
    }
    
    document.getElementById('status').textContent = 'Connecting...';
    connectToRoom();
}

function connectToRoom() {
    myUserId = WSTun.generateId();
    
    client = WSTun.createInstanceClient({
        service: SERVICE,
        instanceUuid: instanceUuid,
        serverToken: serverToken,
        instanceToken: instanceToken,
        userId: myUserId,
        onOpen: () => {
            document.getElementById('status').textContent = 'Joining room...';
        },
        onJoined: (payload) => {
            document.getElementById('joinView').classList.add('hidden');
            document.getElementById('chatView').classList.add('active');
            document.getElementById('roomTitle').textContent = payload.instanceName || 'Chat Room';
            
            // Update URL hash so it can be bookmarked
            let hash = 'instance=' + encodeURIComponent(payload.instanceUuid || instanceUuid);
            hash += '&name=' + encodeURIComponent(myName);
            if (instanceToken) hash += '&token=' + encodeURIComponent(instanceToken);
            if (serverToken) hash += '&server_token=' + encodeURIComponent(serverToken);
            history.replaceState(null, '', '#' + hash);
            
            // Request state from other users
            client.send('request_state', { userId: myUserId, name: myName });
            
            // Announce ourselves
            client.send('user_join', { userId: myUserId, name: myName });
            
            // Add ourselves to users
            users.set(myUserId, { name: myName, joinedAt: Date.now() });
            updateUsersCount();
        },
        onMessage: handleMessage,
        onClose: () => {
            document.getElementById('status').textContent = 'Disconnected';
        },
        onError: (err) => {
            document.getElementById('status').textContent = 'Error: ' + (err.message || 'Failed to join');
        },
        onKicked: () => {
            alert('You have been kicked from the room.');
            location.reload();
        }
    });
    
    client.connect();
}

function handleMessage(msg) {
    switch (msg.type) {
        case 'user_join':
            if (msg.payload.userId !== myUserId) {
                users.set(msg.payload.userId, { name: msg.payload.name, joinedAt: Date.now() });
                addSys(msg.payload.name + ' joined');
                updateUsersCount();
                // Send our state to new user
                sendMyState();
            }
            break;
            
        case 'user_leave':
            const u = users.get(msg.payload.userId);
            if (u) {
                addSys(u.name + ' left');
                users.delete(msg.payload.userId);
                updateUsersCount();
            }
            break;
            
        case 'request_state':
            if (msg.payload.userId !== myUserId) {
                // Add requester to our user list
                users.set(msg.payload.userId, { name: msg.payload.name, joinedAt: Date.now() });
                updateUsersCount();
                // Send our state
                sendMyState();
            }
            break;
            
        case 'state_response':
            if (msg.payload.userId !== myUserId) {
                // Add responder to user list
                users.set(msg.payload.userId, { name: msg.payload.name, joinedAt: Date.now() });
                // Merge recent messages (dedupe by timestamp)
                const existingTs = new Set(messages.map(m => m.ts));
                (msg.payload.recentMessages || []).forEach(m => {
                    if (!existingTs.has(m.ts)) {
                        messages.push(m);
                    }
                });
                messages.sort((a, b) => a.ts - b.ts);
                renderAllMessages();
                updateUsersCount();
            }
            break;
            
        case 'chat_message':
            if (msg.payload.userId !== myUserId) {
                addMsg(msg.payload, false);
            }
            break;
    }
}

function sendMyState() {
    client.send('state_response', {
        userId: myUserId,
        name: myName,
        recentMessages: messages.slice(-30)
    });
}

function leaveChat() {
    if (client) {
        client.send('user_leave', { userId: myUserId, name: myName });
        client.disconnect();
    }
    // Clear hash before reload to prevent auto-rejoin
    history.replaceState(null, '', location.pathname + location.search);
    location.reload();
}

function sendMessage() {
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if (!text || !client) return;
    
    const msg = {
        userId: myUserId,
        userName: myName,
        content: { text },
        ts: Date.now()
    };
    client.send('chat_message', msg);
    addMsg(msg, true);
    input.value = '';
}

function addMsg(msg, own) {
    messages.push({ type: 'chat', ...msg });
    if (messages.length > 100) messages = messages.slice(-80);
    
    const el = document.getElementById('messages');
    el.innerHTML += `<div class="message${own ? ' own' : ''}">
        <div class="message-content">
            <div class="message-header">${esc(msg.userName)}</div>
            ${esc(msg.content?.text || '')}
        </div>
    </div>`;
    el.scrollTop = el.scrollHeight;
}

function addSys(text) {
    messages.push({ type: 'system', text, ts: Date.now() });
    
    const el = document.getElementById('messages');
    el.innerHTML += `<div class="message system"><div class="message-content">${esc(text)}</div></div>`;
    el.scrollTop = el.scrollHeight;
}

function renderAllMessages() {
    const el = document.getElementById('messages');
    el.innerHTML = messages.map(m => {
        if (m.type === 'system') {
            return `<div class="message system"><div class="message-content">${esc(m.text)}</div></div>`;
        } else {
            const own = m.userId === myUserId;
            return `<div class="message${own ? ' own' : ''}">
                <div class="message-content">
                    <div class="message-header">${esc(m.userName)}</div>
                    ${esc(m.content?.text || '')}
                </div>
            </div>`;
        }
    }).join('');
    el.scrollTop = el.scrollHeight;
}

function updateUsersCount() {
    document.getElementById('usersCount').textContent = users.size + ' user' + (users.size !== 1 ? 's' : '');
}

function esc(s) {
    return s ? String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
}

document.getElementById('msgInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});
document.getElementById('nameInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') joinRoom();
});

// Load rooms on start
loadRooms();

// Auto-join if all params provided
if (instanceUuid && hashParams.name) {
    myName = hashParams.name;
    document.getElementById('nameInput').value = myName;
    joinRoom();
}

// Handle page unload
window.addEventListener('beforeunload', () => {
    if (client) {
        client.send('user_leave', { userId: myUserId, name: myName });
    }
});
    </script>
</body>
</html>
